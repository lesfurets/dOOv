<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>DSL.using(java).toGoBeyond(BeanValidation).at(SoftShake.eq(ch));</title>
    <meta name="description" content="Fluent, stream-like API's are great for writing type checked code, taking advantage of Java 8 functions and lambdas. Perhaps the best example of such project is jOOQ, which creates a fluent Java DSL for SQL. But what about creating your own DSL to manipulate and validate your model? We created an open-source framework for generating validation DSLs from a domain model. This presentation will demonstrate the efficiency and expressiveness of this framework to define validation constraints. We will refactor complex legacy business rules during a live code session.">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.css">
    <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">
    <link rel="stylesheet" href="css/softshake-theme.css" id="theme">
    <script>
if( window.location.search.match( /print-pdf/gi ) ) {
  var link = document.createElement( 'link' );
  link.rel = 'stylesheet';
  link.type = 'text/css';
  link.href = 'css/print/pdf.css';
  document.getElementsByTagName( 'head' )[0].appendChild( link );
}
    </script>
  </head>
  <body>
    <div class="footer">
      <img class="logo-lesfurets" src="png/logo_lesfurets_blanc.png">
      <img class="logo-rnday" src="png/softshake/logo-transparent.png">
    </div>
    <div class="reveal">
      <div class="slides">

        <section>
          <img class="logo herve-francois" width="45%" src="png/lf_com_herve_francois.png">
          <h1 class="code">DSL.using(java)<br>
            &nbsp;&nbsp;&nbsp;.toGoBeyond(BeanValidation)<br>
            &nbsp;&nbsp;&nbsp;.at(SoftShake.eq(ch));</h1>
          <p>
          <a href="https://github.com/lesfurets">https://github.com/lesfurets/model-map</a>
          </p>
        </section>

        <section>
          <section>
            <h2>Welcome to the Furets !</h2>
          </section>
          <section>
            <div class="fragment">
              <h2>@dubreuia – Alexandre Dubreuil</h2>
              <ul>
                <li>TODO</li>
              </ul>
            </div>
            <br><br>
            <div class="fragment">
              <h2>@gdigugli – Gilles Di Guglielmo</h2>
              <ul>
                <li>Designer of sweet cooked software since 1999</li>
                <li>Software Architect at LesFurets.com</li>
              </ul>
            </div>
          </section>
          <section>
            <img width="50%" src="png/logo_lesfurets.png">
            <p></p>
            <ul class="fragment">
              <li>1 website, 5 Insurance Products : Car, Health, Home, Bike, Loan</li>
              <li class="emptyline">1 codebase, 450k lines of code, 60k unit tests, 150 selenium tests</li>

              <li>22 Developers, 2 DevOps, 4 Architects</li>
              <li class="emptyline">19 production servers including Load balancers, Frontend, Backend, Databases, BI</li>

              <li>1 release per day</li>
              <li class="emptyline">9 years of code history<br/></li>

              <li>3M quotes/year, 40% of market share, 4M of customers</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h2>Fluent API</h2>
            <p>Àpriori sur Java : c'est verbeux, mais on peut réduire le bruit avec un Fluent API</p>
          </section>
          <section>
            <p>Plusieurs nouveaux idiome nous le permettent : les streams, <code>java.time</code>, les lambda java 8</p>
            <p>Plusieurs librairies "en vogue" en fournissent : jOOQ, guava, etc.</p>
          </section>

          <section>
            <p>Motivation 1 pour écrire un fluent API</p>
            <p>model-map : Mapping bijectif de clef / valeur / modèle</p>
            <p>Utilisé dans notre front comme dictionnaire, pour notre modèle de donnée C*, etc.</p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
SampleModel sampleModel = new SampleModel();
sampleModel.setAccount(new Account());
sampleModel.getAccount().setEmail("chtijug@gmail.com");

// Domain model to map
FieldModel model = new SampleModelWrapper(sampleModel);
Map<FieldId, Object> map = model.stream().collect(toMap(Entry::getKey, Entry::getValue));

// Map to domain model
SampleModelWrapper newModel = map.entrySet().stream()
                            .collect(SampleModelWrapper.toFieldModel());
System.out.println(newModel.getModel().getAccount().getEmail());
              </code></pre>
            </div>
          </section>
          <section>
            <p>Motivation 2 pour écrire un fluent API</p>
            <p>Utilisation de jOOQ dans notre code base, soit un modèle de colonne exprimé avec un DSL permettant de
            générer du SQL
            <p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
DSL.using(conn)
   .selectFrom(BO_INSURANCE)
   .where(BO_INSURANCE.STATUS.equal(CONFIRMED.getCode()))
   .stream()
   .map(InsuranceDAO::InsuranceDto)
   .collect(toList());
              </code></pre>
          </section>
          <section>
            <p>Motivation 3 pour écrire un fluent API</p>
            <p>Exclusions assureurs (équivalent à une règle de validation) écrites sur le modèle OO</p>
            <p>DETTE ! (c'est notre problème à résoudre)</p>
            <div class="code-wrapper smaller">
              <pre><code class="code lang-java" data-trim data-noescape>
AntecedentsAssurance antecedents = conducteur.getHistorique().getAntecedents();
if (conducteur.getTypePermis() == ETypePermis.AUTO
            && !antecedents.isFormation125()
            && (vehicule.getDescription().is3roues() || !vehicule.getDescription().is3roues()
                        && vehicule.getDescription().getCylindree() > 50
                        && vehicule.getDescription().getCylindree() <= 125
                         && DateHelper.isAfter("19800301", conducteur.getPermisConduireAuto()
                         .getDateObtention(), EPrecision.mois))) {
                         for (Assurance a : antecedents.getAssurances()) {
                         if ((DateHelper.isAfter(a.getDateDebut(), "20100131", EPrecision.jour) && a.getCylindree()
                         .getIntervalle().getMin() > 50))
            return;
    }
    if (!antecedents.isAssurancePlus4Ans()) {
        throw new ExclusionException(USAGE);
    }
}
              </code></pre>
          </section>

          <section>
            <p>Ces 3 éléments nous permettent de créer un DSL basé sur model-map (fluent domain), inspiré par le DSL
            de jOOQ (fluent SQL)</p>
          </section>
          <section>
            <p>Pourquoi un dsl ?</p>
            <p>- auditabilité</p>
            <p>- compliance</p>
            <p>- gouvernance</p>
            <p>(voir dernière slide)</p>
          </section>
          <section>
            <p>État actuel : 400 classes d'exclusion et gouvernance basé sur le nom de la classe</p>
            <img data-transition="fade" width="80%" src="png/softshake/exclusion-list.png">
          </section>

          <section>
            <p>Demo model-map : accesseurs du modèle</p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
public class Account extends Identity {

    @SamplePath(field = SampleFieldId.LOGIN)
    private String login;

    @SamplePath(field = SampleFieldId.PASSWD, readable = "password")
    private String password;

}
              </code></pre>
          </section>
          <section>
            <img data-transition="fade" width="80%" src="png/org_modelmap_casper_2.png">
          </section>
          <section>
            <p>Design du dsl</p>
            <p>Point d'entré <code>org.modelmap.core.dsl.DSL#when(StepCondition)</code>, opération <code>StepWhen#validate</code> permet de retourner la règle (avec ou sans message)</p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
public static final ValidationRule EMAIL_VALID = DSL
    .when(EMAIL.matches("\\w+[@]\\w+\\.com")
      .or(EMAIL.matches("\\w+[@]\\w+\\.fr")))
    .validate()
    .withMessage("email finishes with .com or .fr");
              </code></pre>
          </section>

          <section>
            <p>Design du dsl</p>
            <p>Un AST est disponible avec <code>ValidationRule#readable</code></p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
System.out.println(EMAIL_VALID.readable());
&gt; When (email matches \w+[@]\w+\.com or email matches \w+[@]\w+\.fr)
&gt;   validate with message "email finishes with .com or .fr"
              </code></pre>
            </div>
            <p>Pour exécuter la règle il faut appeler <code>ValidationRule#executeOn(FieldModel)</code></p>
            <div class="code-wrapper">
              <pre><code class="code lang-java" data-trim data-noescape>
rules.stream()
    .map(rule -> rule.executeOn(model))
    .filter(Result::isInvalid)
    .map(Result::message)
    .collect(toList());
              </code></pre>
            </div>
          </section>

          <section>
            <img data-transition="fade" width="50%" src="png/softshake/formulaire-auto.png">
          </section>
          <section>
            <div class="code-wrapper small">
              <pre><code class="code lang-java" data-trim data-noescape>
public class Personne implements Serializable {

    @CoordonneesPath(field = COORD_NOM, constraint = SOUSCRIPTEUR)
    protected String nom;

    @CoordonneesPath(field = COORD_PRENOM, constraint = SOUSCRIPTEUR)
    protected String prenom;

    @AutoPath(field = PRINCIPAL_SEXE, constraint = PRINCIPAL)
    @AutoPath(field = SECONDAIRE_SEXE, constraint = SECONDAIRE)
    @EmprunteurPath(field = EMPRUNTEUR_SEXE, constraint = EMPRUNTEUR)
    @EmprunteurPath(field = COEMPRUNTEUR_SEXE, constraint = COEMPRUNTEUR)
    private ESexe sexe;

    @AutoPath(field = PRINCIPAL_NAISSANCE, constraint = PRINCIPAL)
    @AutoPath(field = SECONDAIRE_NAISSANCE, constraint = SECONDAIRE)
    @EmprunteurPath(field = EMPRUNTEUR_NAISSANCE, constraint = EMPRUNTEUR)
    @EmprunteurPath(field = COEMPRUNTEUR_NAISSANCE, constraint = COEMPRUNTEUR)
    private String dateNaissance;

}
              </code></pre>
            </div>
          </section>
          <section>
            <p>Live code 1 : convertir en DSL</p>
            <div class="code-wrapper small">
              <pre><code class="code lang-java" data-trim data-noescape>
public static boolean validateCountry(Account account) {
    if (account.getCountry() == null) {
        return true;
    }
    if (account.getLanguage() == null) {
        return true;
    }
    if (account.getPhoneNumber() == null) {
        return true;
    }
    if (account.getCountry().equals(Country.FR)
                    && account.getLanguage().equals(Language.FR)
                    && account.getPhoneNumber().startsWith("+33")) {
        return true;
    }
    if (account.getCountry().equals(Country.UK)
                    && account.getLanguage().equals(Language.EN)
                    && account.getPhoneNumber().startsWith("+45")) {
        return true;
    }
    return false;
}
              </code></pre>
            </div>
          </section>
          <section>
            <p>JMH</p>
            <div class="code-wrapper small">
              <pre><code class="code lang-java" data-trim data-noescape>
Benchmark                              Mode   Samples         Mean   Mean error    Units
o.m.BenchmarkOldRule.valid_email      thrpt        25     1860.553       42.269   ops/ms
o.m.BenchmarkRule.valid_email         thrpt        25     1733.465       18.461   ops/ms
              </code></pre>
            </div>
            <p>Nouvelle règle légèrement plus lente</p>
          </section>

          <section>
            <p>- bean validation : contrainte sur un modele</p>
            <p>- dsl : resoud pas meme probleme</p>
            <p>- utile pour des champs separes</p>
          </section>

          <section>
            <p>- gouvernance des regles (rappel)</p>
            <p>- expressivite</p>
            <p>- flexibilite ast</p>
            <p>- mieux que bv</p>
          </section>

        </section>

        <section>
          <section>
            <h2>Model-Map available on Github</h2>
            <p></p>
            <ul>
              <li>http://github.com/lesfurets/model-map</li>
              <li class="emptyline">Framework and examples</li>
              <li>Apache Licence</li>
              <li>Try it and contribute !</li>
            </ul>
          </section>
          <section>
            <h2>Thank You!</h2>
            <img width="50%" src="png/rnday/logo-transparent-vert.png">
          </section>
        </section>
            </div>
            </div>
            <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
            <script src="bower_components/reveal.js/js/reveal.js"></script>
            <script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
  controls: false,
  progress: true,
  history: true,
  center: true,
  embedded: true,
  mouseWheel: true,
  viewDistance: 5,

  width: 1280,
  height: 900,
  margin: 0,

  transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

  // Optional libraries used to extend on reveal.js
  dependencies: [
  { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
  { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
  { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
  { src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
  { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
  { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
  ]
});

// navigation with mouse click

window.addEventListener("mousedown", handleClick, false);
window.addEventListener("contextmenu", function(e) { e.preventDefault(); }, false);

function handleClick(e) {
  e.preventDefault();
  if(e.button === 0) Reveal.next();
  if(e.button === 2) Reveal.prev();
}

            </script>
  </body>
</html>
